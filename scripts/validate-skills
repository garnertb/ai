#!/bin/bash
#/ Usage: validate-skills [skill_name]
#/
#/ Validates skill files using the skills-ref validator.
#/ If a skill name is provided, validates only that skill.
#/ Otherwise, validates all skills in the skills/ directory.
#/
#/ OPTIONS:
#/   -h | --help    Show this message.
#/
#/ EXAMPLES:
#/
#/    Validate all skills:
#/      $ validate-skills
#/
#/    Validate a specific skill:
#/      $ validate-skills vscode-tasks-organizer
#/
set -o errexit -o nounset -o pipefail

[[ "${TRACE:-}" ]] && set -x

# Get the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
SKILLS_DIR="${SCRIPT_DIR}/../skills"

if [ "${1:-}" = "--help" ] || [ "${1:-}" = "-h" ]; then
	grep '^#/' <"$0" | cut -c 4-
	exit 2
fi

# Check for uvx
if ! command -v uvx >/dev/null 2>&1; then
	echo "Error: uvx is not installed. Please install uv first: https://docs.astral.sh/uv/" >&2
	exit 1
fi

validate_skill() {
	declare skill_path="$1"
	declare skill_name
	skill_name="$(basename "$skill_path")"

	echo "Validating skill: $skill_name"
	if uvx --from "git+https://github.com/agentskills/agentskills#subdirectory=skills-ref" skills-ref validate "$skill_path"; then
		echo "✓ $skill_name is valid"
		return 0
	else
		echo "✗ $skill_name validation failed"
		return 1
	fi
}

# Track validation results
failed=0
validated=0

if [ -n "${1:-}" ]; then
	# Validate a specific skill
	skill_path="${SKILLS_DIR}/$1"
	if [ ! -d "$skill_path" ]; then
		echo "Error: Skill '$1' not found in ${SKILLS_DIR}" >&2
		exit 1
	fi
	validate_skill "$skill_path" || failed=1
	validated=1
else
	# Validate all skills
	for skill_path in "${SKILLS_DIR}"/*/; do
		# Skip if no directories found
		if [ ! -d "$skill_path" ]; then
			continue
		fi

		# Skip hidden directories and non-skill directories
		skill_name="$(basename "$skill_path")"
		if [ "${skill_name:0:1}" = "." ]; then
			continue
		fi

		validate_skill "$skill_path" || failed=$[failed+1]
		validated=$[validated+1]
	done
fi

echo ""
echo "Validation complete: $validated skill(s) checked, $failed failed"

if [ "$failed" -gt 0 ]; then
	exit 1
fi
